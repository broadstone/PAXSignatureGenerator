<!--
    @author: Mike Burgess (MetricalSky)
    @date: 2016 September 10
-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>PAX Signature Generator Instant Fork</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet"/>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"/>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"/>
    <![endif]-->
</head>
<body>
<div class="container">
    <h1>PAX Signature Generator Instant Fork</h1>

    <div class="panel panel-default">
            <div class="panel-heading">PAX West</div>
            <div class="panel-body">
                <div class="btn-group" data-toggle="buttons">

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2004</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2005</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2006</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2007</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2008</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2009</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2010</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2011</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2012</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2013</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2014</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2015</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2016</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="WEST">2017</label>

                </div>
            </div>
    </div>

    <div class="panel panel-default">
            <div class="panel-heading">PAX East</div>
            <div class="panel-body">
                <div class="btn-group" data-toggle="buttons">

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2010</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2011</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2012</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2013</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2014</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2015</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2016</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="EAST">2017</label>

                </div>
            </div>
    </div>

    <div class="panel panel-default">
            <div class="panel-heading">PAX Aus</div>
            <div class="panel-body">
                <div class="btn-group" data-toggle="buttons">

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="AUS">2013</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="AUS">2014</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="AUS">2015</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="AUS">2016</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="AUS">2017</label>

                </div>
            </div>
    </div>

    <div class="panel panel-default">
            <div class="panel-heading">PAX South</div>
            <div class="panel-body">
                <div class="btn-group" data-toggle="buttons">

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="SOUTH">2015</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="SOUTH">2016</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="SOUTH">2017</label>

                </div>
            </div>
    </div>

    <div class="panel panel-default">
            <div class="panel-heading">PAX Dev</div>
            <div class="panel-body">
                <div class="btn-group" data-toggle="buttons">

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2011</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2012</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2013</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2014</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2015</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2016</label>

                    <label class="btn btn-default"><input type="checkbox" class="paxselect" autocomplete="off" data-pax="DEV">2017</label>

                </div>
            </div>
    </div>
    <div class="panel panel-primary">
      <img id="badges" />
    </div>
    <form method="POST" action="signature.png">
        <div class="panel panel-primary">
            <div class="panel-heading">My PAX</div>
            <table class="table table-striped table-bordered table-responsive">
                <tbody id="my-pax">
                </tbody>
            </table>
            <div class="panel-footer clearfix">
                <label class="btn btn-default">Wrap:
                <select name="wrap">
                    <option value="nowrap">No Wrap</option>

                    <option value="1">1</option>

                    <option value="2">2</option>

                    <option value="3">3</option>

                    <option value="4">4</option>

                    <option value="5">5</option>

                    <option value="6">6</option>

                    <option value="7">7</option>

                    <option value="8">8</option>

                    <option value="9">9</option>

                    <option value="10">10</option>

                    <option value="11">11</option>

                    <option value="12">12</option>

                    <option value="13">13</option>

                    <option value="14">14</option>

                    <option value="15">15</option>

                    <option value="16">16</option>

                    <option value="17">17</option>

                    <option value="18">18</option>

                    <option value="19">19</option>

                    <option value="20">20</option>

                </select>
                </label>
                <label class="btn btn-default">
                    <input type="checkbox" autocomplete="off" name="upload">(beta) Upload to imgur?</label>
                <button type="submit" class="btn btn-primary pull-right">Generate!</button>
            </div>
        </div>
    </form>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>

<script>
    // add or remove My PAX rows as the above year checkboxes are toggled
    $('input:checkbox.paxselect').change(function() {
        var paxid = $(this).data('pax') + $(this).parent().text();

        if ($(this).is(':checked')) {
            $('#my-pax').append(
                '<tr id="' + paxid + '">' +
                    '<td>' + paxid + '</td>' +
                    '<td>' +
                        '<input type="hidden" name="Year[]" value="' + $(this).parent().text() + '"/>' +
                        '<input type="hidden" name="PAX[]" value="' + $(this).data('pax') + '"/>' +
                        '<select class="form-control" name="Badge[]">' +

                            '<option value="ATTENDEE">Attendee</option>' +

                            '<option value="BYOC">BYOC</option>' +

                            '<option value="OMEGANAUT">Omeganaut</option>' +

                            '<option value="MEDIA">Media</option>' +

                            '<option value="ENFORCER">Enforcer</option>' +

                        '</select>' +
                    '</td>' +
                    '<td>' +
                        '<div class="btn-group" data-toggle="buttons">' +
                            '<label class="btn btn-default"><input type="checkbox" name="future[]" class="future-pax"/>Future PAX?</label>' +
                        '</div>' +
                    '</td>' +
                '</tr>');
        } else {
            $('#' + paxid).remove();
        }

        // reset the values of the Future PAX checkboxes to match their index
        $('.future-pax').each(function(index) {
            $(this).attr('value', index);
        })
        $("#my-pax").closest("form").trigger("change")
    })
</script>
<script src="js/jimp.min.js"></script>
<script>
const BADGE_WIDTH = 23;
const BADGE_HEIGHT = 29;
const NUM_WIDTHS = [9,5,9,9,9,9,9,9,9,9];
const NUM_HEIGHT = 11;
const TEXT_OFFSET_Y = 11;
const SPECIAL_TEXT_OFFSET_Y = 7;
const BADGE_TYPES = {"ATTENDEE": {value: 0, name: "Attendee"},
                     "BYOC": {value: 1, name:"BYOC"},
                     "MEDIA": {value: 2, name: "Media"},
                     "OMEGANAUT": {value: 3, name: "Omeganaut"},
                     "ENFORCER": {value: 4, name: "Enforcer"}}
const BADGE_IMG_LOOKUP = {"AUS": "PAX_AUS.png",
                          "DEV": "PAX_DEV.png",
                          "EAST": "PAX_EAST.png",
                          "SOUTH": "PAX_SOUTH.png",
                          "WEST": "PAX_WEST.png" }
const VERYLARGEWRAP = 1000;
var SORTMAGIC = {
  "2004": 	{"WEST":	"2004/08/28"	},
  "2005": 	{"WEST":	"2005/08/26"	},
  "2006": 	{"WEST":	"2006/08/25"	},
  "2007": 	{"WEST":	"2007/08/24"	},
  "2008": 	{"WEST":	"2008/08/29"	},
  "2009": 	{"WEST":	"2009/09/04"	},
  "2010": 	{"EAST":	"2010/03/26",
  			"WEST": 	"2010/09/03"	},
  "2011": 	{"EAST":	"2011/03/11",
  			"WEST": 	"2011/08/26",
  			"DEV": 	"2011/08/24"	},
  "2012": 	{"EAST":	"2012/04/06",
  			"WEST": 	"2012/08/31",
  			"DEV": 	"2012/08/29"	},
  "2013": 	{"EAST":	"2013/03/22",
  			"AUS": 	"2013/07/19",
  			"WEST": 	"2013/08/30",
  			"DEV": 	"2013/08/28"	},
  "2014": 	{"EAST":	"2014/04/11",
  			"AUS": 	"2014/10/31",
  			"WEST": 	"2014/08/29",
  			"DEV": 	"2014/08/27"	},
  "2015": 	{"SOUTH":	"2015/01/29",
  			"EAST": 	"2015/04/22",
  			"AUS": 	"2015/10/30",
  			"WEST": 	"2015/08/28",
  			"DEV": 	"2015/08/26"	},
  "2016": 	{"SOUTH":	"2016/01/29",
  			"EAST": 	"2016/04/22",
  			"AUS": 	"2016/11/04",
  			"WEST": 	"2016/09/02",
  			"DEV": 	"2016/08/31"	},
  "2017": 	{"SOUTH":	"2017/01/29",
  			"EAST": 	"2017/04/01",
  			"AUS": 	"2017/10/31",
  			"WEST": 	"2017/08/31",
  			"DEV": 	"2017/08/30"	} };

for( var obj in SORTMAGIC) {
  for( var pax in SORTMAGIC[obj]) {
    SORTMAGIC[obj][pax] = new Date(SORTMAGIC[obj][pax])
  }
}

function badgeChanged() {
  var badgeform = $(this).serializeArray()
  var futureidxs = badgeform.filter( function(value) {
    return value.name == "future[]"
  })
  var flatbadgearray = badgeform.filter( function(value) {
    return value.name != "future[]"
  })
  var wraparray = badgeform.filter( function(value) {
    return value.name == "wrap"
  })
  var wrap
  if (wraparray.length == 0) {
    wrap = VERYLARGEWRAP
  } else {
    if (wraparray[0].value == "nowrap") {
      wrap = VERYLARGEWRAP
    } else {
      wrap = parseInt(wraparray[0].value, 10)
      if (isNaN(wrap)) {
        wrap = VERYLARGEWRAP
      }
    }
  }

  var badgearray = []
  for( var i = 0; i < flatbadgearray.length; i += 3 ) {
    var thisbadge = flatbadgearray.slice( i, i + 3 )
    var badge = { }
    /* Assume that every 3 items from the form are a group of PAX data */
    if( thisbadge.length == 3 ) {
      for( idx in thisbadge ) {
        if( thisbadge[idx].name == "Year[]") {
          badge.year = Number(thisbadge[idx].value)
        }
        if( thisbadge[idx].name == "PAX[]") {
          badge.PAX = thisbadge[idx].value
        }
        if( thisbadge[idx].name == "Badge[]") {
          badge.badgetype = thisbadge[idx].value.slice(0)
        }
      }
    badge.future = false
    badgearray.push(badge)
    }
  }

  /* Tag the proper future entries */
  for (var i = 0; (i < futureidxs.length) && (i < badgearray.length); i++) {
    var badgenum = Math.floor(Number(futureidxs[i].value))
    if( badgenum < badgearray.length) badgearray[badgenum].future = true
  }
  console.log( badgearray )
  makeImage( badgearray, wrap )
}

function getBadge(fw, pax, year, future, badge_type) {
  var y = future ? BADGE_HEIGHT : 0;
  var x = BADGE_TYPES[badge_type].value * BADGE_WIDTH;
  var badge = new Jimp( BADGE_WIDTH, BADGE_HEIGHT )
  return Jimp.read("../resources/images/" + BADGE_IMG_LOOKUP[pax]).then(function( badgeatlas ) {
    // async bullshit
    badge.blit( badgeatlas, 0, 0, x, y, BADGE_WIDTH, BADGE_HEIGHT )
    drawNumber( badge, badgeatlas, future, year, badge_type )
    return Promise.resolve({"fw": fw, "badge": badge})
  })
}

function drawNumber(badge, badgeatlas, future, year, badge_type) {
  if( (year - 2000) <= 0 ) {
    return;
  }
  var year = Math.floor(year)
  var onesDigit = year % 10
  var tensDigit = Math.floor(year / 10) % 10
  var numWidth = NUM_WIDTHS[onesDigit] + NUM_WIDTHS[tensDigit] + 1;
  var textOffsetX = (BADGE_WIDTH - numWidth) / 2 ;
  var textOffsetY = badge_type == "ATTENDEE" ? TEXT_OFFSET_Y : SPECIAL_TEXT_OFFSET_Y;

  var color = (badge_type == "ENFORCER") || future;
  drawDigit(badge, badgeatlas, tensDigit, color, textOffsetX, textOffsetY);
  drawDigit(badge, badgeatlas, onesDigit, color, textOffsetX + NUM_WIDTHS[tensDigit] + 1, textOffsetY);
}

function drawDigit(badge, badgeatlas, digit, color, x, y) {
    var digitOffsetX = Object.keys(BADGE_TYPES).length * BADGE_WIDTH;
    for(var i = digit - digit % 5; i < digit; i++) {
      digitOffsetX += NUM_WIDTHS[i];
    }
    var digitOffsetY = digit < 5 ? 0 : NUM_HEIGHT;
    if( !color ) {
      digitOffsetY += (NUM_HEIGHT * 2)
    }
    digitImg = badgeatlas.clone().crop( digitOffsetX, digitOffsetY, NUM_WIDTHS[digit], NUM_HEIGHT );
    badge.composite( digitImg, x, y ) // Do not use blit, it doesn't understand transparency
}

function makeImage(badge_array, wrap) {
  var badgeheightoffset = BADGE_HEIGHT + 2
  var badgewidthoffset = BADGE_WIDTH + 2

  rows = Math.ceil(badge_array.length / wrap)
  rows = (isNaN(rows) || ( rows <= 0 )) ? 1 : rows
  rows = (rows > 20) ? 20 : rows
  var image = new Jimp( 1 + badgewidthoffset * Math.min(badge_array.length, wrap), badgeheightoffset * rows )
  var offset = 1
  if( (badge_array === undefined) || badge_array.length == 0 ) {
    image.getBase64(Jimp.MIME_PNG, function (err, datauri) {
      setBadgeImage(datauri)
    })
    return // We've setup the image to be blanked, so bail.
  }

  badge_array.sort(function(a,b) {
    adate = new Date(SORTMAGIC[a.year][a.PAX])
    bdate = new Date(SORTMAGIC[b.year][b.PAX])
    return (adate - bdate)
  })

  for( var badge_idx = 0; badge_idx < badge_array.length; badge_idx++ ) {
    var fw = {"badge_idx": badge_idx}
    var badgedata = getBadge( fw, badge_array[badge_idx].PAX, badge_array[badge_idx].year, badge_array[badge_idx].future, badge_array[badge_idx].badgetype )

    badgedata.then( function(data) {
      var y = Math.floor(data.fw.badge_idx / wrap)
      var x = Math.floor(data.fw.badge_idx % wrap)
      image.blit( data.badge, x * badgewidthoffset, y * badgeheightoffset )
      // Mind the callback that delays setting the image until the base64 is calculated
      image.getBase64(Jimp.MIME_PNG, function (err, datauri) {
        setBadgeImage(datauri)
      })
    })
  }
}

function setBadgeImage(datauri) {
  badge_dom = document.getElementById("badges")
  badge_dom.src = datauri
}

$(document).ready(function () {
  //TODO: Add ID to form
  var theform = $("#my-pax").closest("form")
  theform.change( badgeChanged )
  $("#my-pax").change( function() {
    theform.trigger( "change" )
  })
})
</script>

</body>
</html>
